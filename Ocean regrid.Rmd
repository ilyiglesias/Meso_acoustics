---
title: "Regrid CTD data by 25 25 km cells"
output: html_notebook
---

# Objective of code:
the following code extracts CTD data for each re-gridded acoustic data cell (25km by 25km). This is different from Ocean data.rmd which processes all of the CTD data (visualizing profiles, smoothing data, calculating spice etc.) as well as Regrid.Rmd which re-gridded all of the acoustics data.

# CTD variables:
I am interested in re-gridding the following CTD data:
- Temperature (175m, 500m)
- Oxygen (175m, 500m)
- Density (175m, 500m)
- Chl-a (upper 100m integrated) sum
- Dyn-height (at 500m, anomaly)

and calculating
- dynamic height anomalies (at 500m) 
- the overall mean center of mass (CM) for all cells and years (25km by 25km)

# Calculate the mean CM depth

```{r mean cm 25km cells}
mean(acoustics_regrid_25km$cm_m) #322 (rounded to nearest 2m depth bin 322.66)

range(acoustics_regrid_25km$cm_m) # 230 m--411 m pretty narrow range

# Mean CM per year
acoustics_regrid_25km |> 
  group_by(year) |> 
  summarise(cm=mean(cm_m), .groups='drop')
```

# REGRID CTD DATA

# Regrid CTD data - TEMPERATURE at 175 m
IMPORTANT NOTE: I am using the SAME grid developed for our acoustics data (with removed filter for # of cells per column of water). As such, the raster grid input "r" depends on the input to Regrid.Rmd, so ensure you have the correct grid cell size prior to running the following code!!! 

Prior to running, I ensured that our cell size was 25 km in Regrid.Rmd df (raster object= r)
# Regrid CTD data - TEMPERATURE at 175 m 
```{r CTD: temperature at 175m}

# check resolution of raster layer : should be 25000 and 25000
res(r)

# ensure the grids from acosutics_regrid are appropriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_temp_175m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH==175) #MANUAL::: select for depths of interest, 150m, 500m, and CM depth
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$TEMPERATURE, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 150m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, temp_175m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  





# store output to df
ctd_temp_175m <- rbind(ctd_temp_175m, x_yr_df)

}


# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_temp_175m_sf <- st_as_sf(x=ctd_temp_175m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_temp_175m_sf <- st_transform(ctd_temp_175m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_temp_175m_sf <- ctd_temp_175m_sf  |> 
              dplyr::mutate(lon = sf::st_coordinates(ctd_temp_175m_sf)[,1], # extract lon from geometry col
              lat = sf::st_coordinates(ctd_temp_175m_sf)[,2]) |>  #extract lat from geometry col
              dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_temp_175m <- as.data.frame(st_drop_geometry(ctd_temp_175m_sf))

#remove intermediary dfs
rm(ctd_temp_175m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```

# Regrid CTD data - TEMPERATURE at 500m
At a 25km resolution, mean temperature at 500m
```{r CTD: temperature at 500m}

# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are apprpriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_temp_500m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH==500) #MANUAL::: select for depths of interest, 150m, 500m, and CM depth
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$TEMPERATURE, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 500m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, temp_500m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  
# store output to df
ctd_temp_500m <- rbind(ctd_temp_500m, x_yr_df)

}

# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_temp_500m_sf <- st_as_sf(x=ctd_temp_500m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_temp_500m_sf <- st_transform(ctd_temp_500m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_temp_500m_sf <- ctd_temp_500m_sf |> 
                      dplyr::mutate(lon = sf::st_coordinates(ctd_temp_500m_sf)[,1], # extract lon from geometry col
              lat = sf::st_coordinates(ctd_temp_500m_sf)[,2]) |>  #extract lat from geometry col
              dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_temp_500m <- as.data.frame(st_drop_geometry(ctd_temp_500m_sf))

#remove intermediary dfs
rm(ctd_temp_500m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```


#surface temperature
# Regrid CTD data - mean TEMPERATURE in upper 10m
At a 25km resolution, mean temperature at 500m
```{r CTD: temperature at surface}

# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are apprpriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_temp_10m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH<=10) #MANUAL::: select for depths of interest, upper 10m and will take mean per grid cell
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$TEMPERATURE, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 500m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, temp_10m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  
# store output to df
ctd_temp_10m <- rbind(ctd_temp_10m, x_yr_df)

}

# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_temp_10m_sf <- st_as_sf(x=ctd_temp_10m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_temp_10m_sf <- st_transform(ctd_temp_10m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_temp_10m_sf <- ctd_temp_10m_sf |> 
                      dplyr::mutate(lon = sf::st_coordinates(ctd_temp_10m_sf)[,1], # extract lon from geometry col
              lat = sf::st_coordinates(ctd_temp_10m_sf)[,2]) |>  #extract lat from geometry col
              dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_temp_10m <- as.data.frame(st_drop_geometry(ctd_temp_10m_sf))

#remove intermediary dfs
rm(ctd_temp_10m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```


```{r}
ctd_temp_10m= ctd_temp_10m |> 
              dplyr::select(-count_ctds)
#acoustics_ctd= left_join(acoustics_ctd, ctd_temp_10m, by=c("lat", "lon", "year"))
```


# Regrid CTD data - OXYGEN at 175m
25km by 25km grid cell 
```{r CTD: oxygen at 175 m}

# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are apprpriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_o2_175m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH==175) #MANUAL::: select for depths of interest, 175m, 500m, and CM depth
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$OXYGEN, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 150m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, o2_175m=layer.2) |> #rename col names based on their true values: length and identity (value at 175m)
  mutate(year=yr[i]) #create col for year for when we merge later
  


# store output to df
ctd_o2_175m <- rbind(ctd_o2_175m, x_yr_df)

}


# note this output ctd_temp_175m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_o2_175m_sf <- st_as_sf(x=ctd_o2_175m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_o2_175m_sf <- st_transform(ctd_o2_175m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_o2_175m_sf <- ctd_o2_175m_sf |> 
                      dplyr::mutate(lon = sf::st_coordinates(ctd_o2_175m_sf)[,1], # extract lon from geometry col
                      lat = sf::st_coordinates(ctd_o2_175m_sf)[,2]) |>  #extract lat from geometry col
                      dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_o2_175m <- as.data.frame(st_drop_geometry(ctd_o2_175m_sf))

#remove intermediary dfs
rm(ctd_o2_175m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```

# Regrid CTD data - OXYGEN at 500m
25km by 25km grid cell 
```{r CTD: oxygen at 500m}

# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are apprpriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_o2_500m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH==500) #MANUAL::: select for depths of interest, 150m, 500m, and CM depth
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$OXYGEN, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 150m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, o2_500m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  


# store output to df
ctd_o2_500m <- rbind(ctd_o2_500m, x_yr_df)

}


# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_o2_500m_sf <- st_as_sf(x=ctd_o2_500m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_o2_500m_sf <- st_transform(ctd_o2_500m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_o2_500m_sf <- ctd_o2_500m_sf |> 
                  dplyr::mutate(lon = sf::st_coordinates(ctd_o2_500m_sf)[,1], # extract lon from geometry col
                  lat = sf::st_coordinates(ctd_o2_500m_sf)[,2]) |>  #extract lat from geometry col
                  dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_o2_500m <- as.data.frame(st_drop_geometry(ctd_o2_500m_sf))

#remove intermediary dfs
rm(ctd_o2_500m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```



# Regrid CTD data - DENSITY at 175 m
25km by 25km grid cell 

```{r CTD: density at 175m}

# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are apprpriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_den_175m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH==175) #MANUAL::: select for depths of interest, 175m, 500m, and CM depth
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$DENSITY, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 150m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, den_175m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  


# store output to df
ctd_den_175m <- rbind(ctd_den_175m, x_yr_df)

}


# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_den_175m_sf <- st_as_sf(x=ctd_den_175m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_den_175m_sf <- st_transform(ctd_den_175m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_den_175m_sf <- ctd_den_175m_sf |> 
                  dplyr::mutate(lon = sf::st_coordinates(ctd_den_175m_sf)[,1], # extract lon from geometry col
                  lat = sf::st_coordinates(ctd_den_175m_sf)[,2]) |>  #extract lat from geometry col
                  dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_den_175m <- as.data.frame(st_drop_geometry(ctd_den_175m_sf))

#remove intermediary dfs
rm(ctd_den_175m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```


# Regrid CTD data - DENSITY at 500m
25km by 25km grid cell 

```{r CTD: density at 500m}

# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are apprpriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_den_500m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH==500) #MANUAL::: select for depths of interest, 150m, 500m, and CM depth
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$DENSITY, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 150m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, den_500m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  


# store output to df
ctd_den_500m <- rbind(ctd_den_500m, x_yr_df)

}


# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_den_500m_sf <- st_as_sf(x=ctd_den_500m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_den_500m_sf <- st_transform(ctd_den_500m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_den_500m_sf <- ctd_den_500m_sf |> 
                  dplyr::mutate(lon = sf::st_coordinates(ctd_den_500m_sf)[,1], # extract lon from geometry col
                  lat = sf::st_coordinates(ctd_den_500m_sf)[,2]) |>  #extract lat from geometry col
                  dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_den_500m <- as.data.frame(st_drop_geometry(ctd_den_500m_sf))

#remove intermediary dfs
rm(ctd_den_500m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```

# Regrid CTD data - Chlorophyl-- depth integrated upper 100m
25km by 25km grid cell 

NOTE: these data were smoothed by the preceding and succeeding cell (2m above and below) variable: chl_smooth

```{r CTD: chl depth integrated to 100m}

# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are appropriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr=unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_chl_100m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH<= 100) #MANUAL::: select for depth of interest
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$chl_smooth, fun=function(x,...) c(length(x), sum(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 150m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, chl_100m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  


# store output to df
ctd_chl_100m <- rbind(ctd_chl_100m, x_yr_df)

}


# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_chl_100m_sf <- st_as_sf(x=ctd_chl_100m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_chl_100m_sf <- st_transform(ctd_chl_100m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_chl_100m_sf <- ctd_chl_100m_sf |> 
                   dplyr::mutate(lon = sf::st_coordinates(ctd_chl_100m_sf)[,1], # extract lon from geometry col
                    lat = sf::st_coordinates(ctd_chl_100m_sf)[,2]) |>  #extract lat from geometry col
                    dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_chl_100m <- as.data.frame(st_drop_geometry(ctd_chl_100m_sf))

#remove intermediary dfs
rm(ctd_chl_100m_sf) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```
NOTE: count_ctds values not reflective of total number of CTDs (rather total number of cells that went into calculating sum over upper 100m)

# Regrid CTD data - DYNAMIC HEIGHT ANOMALIES at 500m
25km by 25km grid cell 

#Calculate mean dynamic height at 500m
The mean value of dynamic height at 500m for all ctd casts (all locations, years)
```{r}
# Filter for dynamic height at 500m 
dyn_ht_500= ctd_deep_data_core |> 
            filter(CTD_DEPTH==500) 

# calculate mean dynamic height at 500m
mean(dyn_ht_500$DYN_HGT) # 0.8208554
range(dyn_ht_500$DYN_HGT) # range of 0.69 to 2.48 (quite a difference actually)
# we are going to call this 0.82 m- which is the closest centimeter i believe 

ctd_deep_data_core |> 
filter(CTD_DEPTH==500) |> 
group_by(year) |> 
summarise(dy_ht=mean(DYN_HGT), .groups = 'drop')

#rm(dyn_ht_500)
```
#REmove dyn_ht outliers (> 3std from mean)
This leads to the removal of TWO dynamic height values at 500m:
2016: CTD_IDEX 184 (dynamic height value of 2.48m which seems pretty high indeed)
2017: CTD_INDEX 28 (dyanamic height of 1.3)
JUST for reference! The code below for re-grid automatically removes our two problematic values 
```{r}

mean(dyn_ht_500$DYN_HGT) # 0.8208654
sd(dyn_ht_500$DYN_HGT) #0.130607


# SO 1 std dev from the mean is + or - (mean +/- 1sd)
mean(dyn_ht_500$DYN_HGT)+sd(dyn_ht_500$DYN_HGT)

# by this same logic, 3 std dev would be 
mean(dyn_ht_500$DYN_HGT)+3*sd(dyn_ht_500$DYN_HGT) # 1.212
mean(dyn_ht_500$DYN_HGT)-3*sd(dyn_ht_500$DYN_HGT) #0.4290444

# so if any of our values are less than 0.4 or greater than 1.2, we consider them here to be outliers

# plot 
ggplot(data=dyn_ht_500) +
  geom_density(aes(x=DYN_HGT))+
  ggthemes::theme_few()

# or as a boxplot
ggplot(dyn_ht_500,aes(x=factor(0),y=DYN_HGT))+
geom_boxplot()+
  geom_text(aes(x=factor(0), y=DYN_HGT, label=paste0(CTD_INDEX, ",  ", year)))+
  geom_hline(yintercept=mean(dyn_ht_500$DYN_HGT)+3*sd(dyn_ht_500$DYN_HGT), color="red")+
  geom_hline(yintercept=mean(dyn_ht_500$DYN_HGT)-3*sd(dyn_ht_500$DYN_HGT), color="red")

# which values of dynamic height appear to be way outside the range of the study

# REMOVE outliers of dynamic height
dyn_ht_500= dyn_ht_500 |> 
 dplyr::filter(!(year==2017 & CTD_INDEX==28)) |> 
  dplyr::filter(!(year==2016 & CTD_INDEX==184))

```

# Regrid CTD data - DYNAMIC HEIGHT ANOMALY at 500m --- WITH OUTLIERS removed!!! (code includes removing outliers)
25km by 25km grid cell 

```{r CTD: dyamic height anomaly at 500 m}

# add a column to CTD data for dynamic height - mean dynamic height
ctd_deep_data_core= ctd_deep_data_core |> 
                    mutate(dyn_ht_anom= DYN_HGT-0.82)


# check resolution of raster layer 
res(r)

# ensure the grids from acosutics_regrid are apprpriate for this size (ex. 20km)
acoustics_regrid= acoustics_regrid_25km


# FOR LOOP: For each unique year of CTD data (and acoustics)
yr= unique(ctd_deep_data_core$year)

# MANUAL::: create df to store output in
ctd_dyn_ht_500m <- data.frame() # MANUAL!!!!

for(i in 1:length(yr)){
  #filter for given year
  ctd_yr <- ctd_deep_data_core |> 
             dplyr::filter(!(year==2017 & CTD_INDEX==28)) |> # remove outliers
             dplyr::filter(!(year==2016 & CTD_INDEX==184)) |>  #remove outliers
             filter(year==yr[i]) |> #select for one year at a time
             filter(CTD_DEPTH==500) #MANUAL::: select for depths of interest, 150m, 500m, and CM depth
             
  
  # convert to sf object
  ctd_yr_sf <- st_as_sf(x=ctd_yr, coords=c('LONGITUDE','LATITUDE'), remove = FALSE, crs=4326) #sf object with lat lon coord system
  ctd_yr_sf <- st_transform(ctd_yr_sf, crs=32610)# Convert to projected coordinate system (UTM Zone 10N, datum: WGS84) to match raster r
  
  # rasterize our CTD data to our acoustics grid (r) created previously (of distance dist=)
  x_yr<- raster::rasterize(x=ctd_yr_sf, y=r, field=ctd_yr_sf$dyn_ht_anom, fun=function(x,...) c(length(x), mean(x, na.rm=TRUE))) #MANUAL 
  #this returns the mean value at 150m per cell. In those cases where there were only one CTD, this should just be that single value
  
# convert raster output to dataframe object
x_yr_df<- raster::as.data.frame(x=x_yr, xy=TRUE, centroids=TRUE, na.rm=TRUE) 
x_yr_df <- x_yr_df |> 
  rename(lon=x, lat=y, count_ctds=layer.1, dyn_ht_500m=layer.2) |> #rename col names based on their true values: length and identity (value at 150m)
  mutate(year=yr[i]) #create col for year for when we merge later
  


# store output to df
ctd_dyn_ht_500m <- rbind(ctd_dyn_ht_500m, x_yr_df)

}


# note this output ctd_temp_150m is in UTM Zone 10N- need to convert back to WGS 84: LAT LON coordinate reference system
ctd_dyn_ht_500m_sf <- st_as_sf(x=ctd_dyn_ht_500m, coords=c('lon','lat'), remove = FALSE, crs=32610) # convert to SF object with UTM Zone 10N
ctd_dyn_ht_500m_sf <- st_transform(ctd_dyn_ht_500m_sf, crs=4326)# Convert coordinate system from utm zone 10N back to WGS 84 (Lon Lat)

# break geometry column into two columns for lon and lat
ctd_dyn_ht_500m_sf <- ctd_dyn_ht_500m_sf |> 
                  dplyr::mutate(lon = sf::st_coordinates(ctd_dyn_ht_500m_sf)[,1], # extract lon from geometry col
                  lat = sf::st_coordinates(ctd_dyn_ht_500m_sf)[,2]) |>  #extract lat from geometry col
                  dplyr::select(-geometry)


# convert from sf back to  dataframe
ctd_dyn_ht_500m <- as.data.frame(st_drop_geometry(ctd_dyn_ht_500m_sf))

#remove intermediary dfs
rm(ctd_dyn_ht_500m_sf, dyn_ht_500) #no longer need this sf since we converted to df
rm(ctd_yr, ctd_yr_sf, x_yr, x_yr_df) #output from for loop

```

# Join ALL OCEANOGRAPHIC variables to acoustics data (grid)!!

CTD data from 150m, 500m and center of mass (CM) 314m depth

Would like to join this CTD data to existing regrided acoustics data (acoustics_regrid)

ctd_chl_100m
ctd_den_175m
ctd_den_500m
ctd_dyn_ht_500m
ctd_o2_175m
ctd_o2_500m
ctd_o2_cm
ctd_temp_175m
ctd_temp_500m
ctd_temp_cm

```{r Join regridded CTD data}
# now merge the individual df's to acoustics regrid based on latitude and longitude (which should be the same because they are also representing centroid values)

# Convert class type from character to numeric to match our oceano variables
acoustics_regrid$year <- as.numeric(acoustics_regrid$year)



acoustics_ctd= left_join(acoustics_regrid, ctd_temp_175m, by=c("year", "lat", "lon")) #temp at 175m

acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_chl_100m, year, lon, lat, chl_100m), by=c("year", "lat", "lon")) #Join density at 150m
acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_den_175m, year, lon, lat, den_175m), by=c("year", "lat", "lon")) #Den at 150m
acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_den_500m, year, lon, lat, den_500m), by=c("year", "lat", "lon")) #Den at 500m
acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_dyn_ht_500m, year, lon, lat, dyn_ht_500m), by=c("year", "lat", "lon")) #dyn ht anom at 500m
acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_o2_175m, year, lon, lat, o2_175m), by=c("year", "lat", "lon")) #oxygen at 150m
acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_o2_500m, year, lon, lat, o2_500m), by=c("year", "lat", "lon")) #oxygen at 500m
acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_temp_500m, year, lon, lat, temp_500m), by=c("year", "lat", "lon")) #temp at 500m
#acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_temp_10m, year, lon, lat, temp_10m), by=c("year", "lat", "lon")) #temp at >10m
#acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_temp_cm, year, lon, lat, temp_cm), by=c("year", "lat", "lon")) #temp at mean cm depth 322 m
#acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_temp_200m, year, lon, lat, temp_200m), by=c("year", "lat", "lon")) #temp 200m
#acoustics_ctd= left_join(acoustics_ctd, dplyr::select(ctd_o2_200m, year, lon, lat, o2_200m), by=c("year", "lat", "lon")) #oxygen 200m
# 122 grid cells

# Remove those cells that have acoustics data but no associated CTD data...
acoustics_ctd= acoustics_ctd |> 
               filter(!is.na(temp_175m))
# thisis a total of 92 rows (or cells with acoustics and ctd data).. however, there is ONE more oceanographic variable (dynamic height anomaly) missing a value (boooo!) so we have to remove one additional cell (for a total of 91)
acoustics_ctd= acoustics_ctd |> 
               filter(!is.na(dyn_ht_500m))

# okay we have a total of 91 cells that have both acoustics and ALL oceanogrpahic data available!


# clean up intermediary files
rm(ctd_chl_100m, ctd_den_175m, ctd_den_500m, ctd_dyn_ht_500m, ctd_o2_175m, ctd_o2_500m, ctd_temp_175m, ctd_temp_500m)

```


# NEXT
move to satellite.Rmd to add satellite derived light data to our df of oceanic and acoustic data acoustics_ctd












