---
title: "Environmental variables plots"
output: html_notebook
---

This code was written by II for the manuscript: https://doi.org/10.1093/icesjms/fsae129
This code is preceded by "Analysis 2.Rmd" and is the final script of this project.

# Objective of code:
In this final .Rmd we are interested in plotting our study region, calculating summary stats about our acoustic tracks and plotting the location various ctd data 

- bathymetry map of acoustic tracks (where did we sample?)
- each oceanographic variable plotted per year

# Background
We would like to have a plot showing the larger study are for reference as well as the oceanographic variables we sampled over this region

# Study area-- Map of acoustic tracks

# Add bathymetry 
Using marmap package, load NOAA bathymetry data
NOTE: these data are also loaded in Read Clean.Rmd
```{r}
library(marmap) # package for loading bathy data

# select for our region
range(echo_integration_all$Lat_M) #36 to 38.5
range(echo_integration_all$Lon_M) # -125 to -121

bathy <- getNOAA.bathy(lon1 = -125, lon2 = -121,
lat1 = 35, lat2 = 40, resolution = 1)

?getNOAA.bathy # for documentation

plot(bathy)

#convert to xyz data
bathy_xyz <- as.xyz(bathy)

#select for only ocean depths (avoid land) but while keeping V1 and V2
baty_xyz= bathy_xyz |> 
  filter(V3<=0) # land values are positive while ocean are negative so select for only negative values

##convert to dataframe for ggplot
#bathy_xyz_fortify= fortify(bathy_xyz)
```
# Mean depth
overall mean depth of sampled area
```{r}
bathy_acoustic_track |> 
  summarise(mean_depth=mean(depth))
```



# PLOT acoustic tracks with underlying bathymetry data
The following plot:
- plots bathymetry contour with specific depths displayed
- acoustic track overlay
- contour of specific 550 m selection depth (used data deeper than 550m bottom depth) *note there is one spot at the top of the map (see 2013) where tracks appear to be on right of line. Prob due to discrepancy between acousticcally detected bottom and resolution of noaa marmap plots (or start of canyon it looks like)
```{r}

ggplot(data=bathy_xyz)+
  #geom_contour(data=bathy_xyz, aes(x=V1, y=V2, z=V3), breaks = c(-200, -1000, -3000, -4000), color="#56B4E9" , linewidth=0.09)+ #Depth breaks
  annotate(geom="text", x=-122.1, y=36, label="725 m", color="#0072B2", size=3)+ #label contour
  geom_point(data= echo_integration_all, aes(x=Lon_M, y=Lat_M), shape=21, size=0.20, color=  "#D55E00" , alpha=0.65)+ #add acoustic track location info
  geom_sf(data=states, fill= "#999999" , alpha=0.25, color="black", lwd=0.25)+ #state outline
  coord_sf(xlim=c(-124.5, -121 ), ylim=c(36 ,38.5))+ #study region "core" area
  geom_contour(data=bathy_xyz, aes(x=V1, y=V2, z=V3), breaks = c(-725), color="#0072B2", size=0.5)+ # depth minimum value of 725m
  xlab("")+
  ylab("")+
  theme(axis.text.x  = element_text(angle=90),
        panel.grid = element_blank(),
        panel.background = element_rect(fill="white"))+
  facet_wrap(~year)

#ggsave("./plots/coverage.pdf", dpi=300) #pdf
```

# Basemaps
```{r}
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")


coast <- rnaturalearth::ne_coastline(scale = "medium", returnclass = "sf")
countries <- rnaturalearth::ne_countries(scale = "medium", returnclass = "sf")
states <- rnaturalearth::ne_states(returnclass = "sf")
?ne_states()

# to view
ggplot() +
  geom_sf(data= coast)
```

# Plot: zoomed out study area
```{r}

ggplot()+
  geom_sf(data=states, fill= "#999999" , alpha=0.25, color="black", lwd=0.25)+
  geom_point(data= echo_integration_all, aes(x=Lon_M, y=Lat_M), shape=21, size=0.20, color= "#D55E00" , alpha=0.65)+ #add acoustic track location info
  annotate(geom="text", x=-120.5, y=37.75, label="San Francisco", color="black", size=3)+ # sf
  annotate(geom="point", x=-122.44, y=37.75, color="#0072B2", size=2, shape=8)+ 
  annotate(geom="text", x=-120.75, y=36.55, label="Monterey", color="black", size=3)+ 
  annotate(geom="point", x=-121.89, y=36.55, color="#0072B2", size=2, shape=8)+ 
  annotate(geom="text", x=-122.5, y=40.44, label="Cape Mendocino", color="black", size=3)+ 
  annotate(geom="point", x=-124.4, y=40.44, color="#0072B2", size=2, shape=8)+
  annotate(geom="text", x=-118.5, y=32.6, label="San Diego", color="black", size=3)+ 
  annotate(geom="point", x=-117.16, y=32.7, color="#0072B2", size=2, shape=8)+
  coord_sf(xlim=c(-125, -117 ), ylim=c(32 ,42))+ #study region "core" area
  xlab("")+
  ylab("")+
  theme(axis.text.x  = element_text(angle=90),
        panel.grid = element_blank(),
        panel.background = element_rect(fill="white"))

# save output
ggsave("./plots/analysis 2/coverage_wide.pdf",dpi=300) #pdf
```

# Start and end date of acoustic tracks per year
```{r}
echo_integration_all |> 
  group_by(year) |> 
  reframe(time_range=range(time)) #start and end dates per year
```
# CTD date range

```{r}
ctd_deep_data_core |> 
  group_by(year) |> 
  reframe(min_date= min(date_parsed, na.rm = T),
          max_date= max(date_parsed, na.rm = T)) #start and end dates per year


# Number of total ctds
acoustics_ctd |> 
  group_by(year) |> 
  summarise(no_ctds=sum(count_ctds))

acoustics_ctd |> 
  summarise(no_ctds=sum(count_ctds)) #total of 191 casts
```

# PLOT of grid cells with acoustic track and CTD position overlaid 

```{r}

# Plot grid cells with acoustic tracks and ctd cast locations
ggplot()+
  geom_sf(data=states)+ # add a basemap
  coord_sf(xlim=c(-124.5, -121 ), ylim=c(36 ,39))+ #study region
  geom_point(data=echo_integration_all, aes(x=Lon_M, y=Lat_M), color="#D55E00" , size=0.55, alpha=0.50)+ #cells with at least 3 fine resolution cells 
  geom_point(data=ctd_deep_loc_core, aes(x=LONGITUDE, y=LATITUDE), shape=3, size=1,color="black", stroke=0.5)+ # all ctd locations
  geom_point(data=acoustics_ctd, aes(x=lon, y=lat), size=4, shape=22, color="black" , stroke=0.50, alpha=0.5)+  # grid cell 
  labs(fill="Center of mass [m]")+#change legend title
  #scale_x_continuous(breaks = lon, minor_breaks = NULL)+ #note skipping lines now because not min, max
  #scale_y_continuous(breaks=lat, minor_breaks = NULL)+
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(), #tick marks from lat long coordinates
        #panel.grid = element_line(colour = "grey", linetype = "solid", linewidth =0.05),# removed gridlines but could readd here
        panel.background = element_blank())+
  labs(x="", y="")+ 
  facet_wrap(~year)

ggsave(filename = "./plots/analysis 2/coverage_grid_ctd.pdf") 
#ggsave(filename = "./plots/analysis 2/coverage_grid_ctd.png", dpi=300) #png
```
#  Plot grid cells with acoustics + ocean variables
```{r}
{ggplot()+
  geom_sf(data=states, fill="gray", color="black")+
  coord_sf(xlim=c(-124.5, -121 ), ylim=c(36 ,39))+ #study region
  geom_point(data=acoustics_ctd, aes(x=lon, y=lat, fill=cm_m), shape=22, size=3.5, alpha=0.9)+ # cells
  scale_fill_viridis_c(direction=-1)+ # scale center of mass depth
  geom_point(data=ctd_deep_loc_core, aes(x=LONGITUDE, y=LATITUDE), shape=1, size=1,color="white", stroke=0.5)+ # all ctd locations
  labs(x="", y="", fill="CM")+ 
  theme(axis.text.x  = element_text(angle=90),
        panel.grid = element_blank(),
        panel.background = element_rect(fill="white"))+
  facet_wrap(~year)}
  
ggsave(file="./plots/analysis 2/ctd_grid.pdf")
  
```
# Oceanographic variables between years

# Calculate mean values 
```{r}

# calculate median values for labeling plot
summary_yrs= acoustics_ctd |> 
               group_by(year) |> 
               summarise(median_cm=median(cm_m),
                         mean_cm=mean(cm_m),
                         median_dyn_ht=median(dyn_ht_500m), 
                         mean_dyn_ht=mean(dyn_ht_500m),
                         median_MVBS=median(MVBS),
                         mean_MVBS=mean(MVBS),
                         median_temp_10m=median(temp_10m),
                         mean_temp_10m=mean(temp_10m),
                         median_temp_175m=median(temp_175m),
                         mean_temp_175m=mean(temp_175m),
                         median_Z=median(Z),
                         mean_Z= mean(Z),
                         median_o2_175m= median(o2_175m),
                         mean_o2_175m=mean(o2_175m),
                         median_o2_500m=median(o2_500m),
                         mean_o2_500m=mean(o2_500m),
                         median_chl=median(chl_100m),
                         mean_chl=mean(chl_100m),
                         n=n()) #calculate the mean value per year

summary_yrs$year= as.factor(summary_yrs$year) # convert year to a factor
class(summary_yrs$year)
```

# Dynamic height between years
```{r}

ggplot(data=acoustics_ctd, aes(x=as.factor(year), y=dyn_ht_500m, group=year, color=as.factor(year)))+
  stat_boxplot(geom="errorbar", width=0.25)+
  geom_boxplot( aes(group=year), outlier.shape=NA, show.legend = FALSE)+ #plot boxplots without outliers since in jitter
  scale_color_manual(values = c("2013"="black" , "2014"="black", "2015"="#D55E00" , "2016"= "#D55E00" , "2017"="black", "2018"="black"))+
  geom_jitter(alpha=0.3, color="#999999" , width=0.15)+ #add actual data points to our boxplot
  geom_text(data= summary_yrs, aes(x = year, y = median_dyn_ht, label = paste0("Median:", round(median_dyn_ht, 2))), size = 2.5, vjust = -0.5)+ #label median 
  #geom_text(data= summary_yrs, aes(x =year, y = median_dyn_ht, label = paste0("n: ", n)), size = 3, vjust = 1.5, color="black")+ #label sample size 
  geom_hline(yintercept=0, linewidth=0.5, color="black", alpha=0.6)+ # 0 intercept
  xlab("Year")+
  ylab("Dynamic height anomaly [m]")+
  ggthemes::theme_few()+
  theme(legend.position = 'none')

ggsave(filename = "./plots/analysis 2/oceano/box_dyn_ht.pdf", width=170, height= 100,units="mm", dpi=300)
```

# Light between years 
```{r}

ggplot(data=acoustics_ctd, aes(x=as.factor(year), y=Z, group=year, color=as.factor(year)))+
  stat_boxplot(geom="errorbar", width=0.25)+
  geom_boxplot( aes(group=year), outlier.shape=NA, show.legend = FALSE)+ #plot boxplots without outliers since in jitter
  scale_color_manual(values = c("2013"="black" , "2014"="black", "2015"="#D55E00" , "2016"= "#D55E00" , "2017"="black", "2018"="black"))+
  geom_jitter(alpha=0.3, color="#999999" , width=0.15)+
  geom_text(data= summary_yrs, aes(x = year, y = median_Z, label = paste0("Median:", round(median_Z, 2))), size = 2.5, vjust = -0.5)+ #label
  scale_y_reverse()+ #deeper at bottom of plot easier for me to grasp
  xlab("Year")+
  ylab("Euphotic depth (Z) [m]")+
  ggthemes::theme_few()+
  theme(legend.position = 'none')

ggsave(filename = "./plots/analysis 2/oceano/box_light.pdf", width=170, height= 100,units="mm", dpi=300)
```
# Temp at meso depths (175m) between years 
```{r}

ggplot(data=acoustics_ctd, aes(x=as.factor(year), y=temp_175m, group=year, color=as.factor(year)))+
  stat_boxplot(geom="errorbar", width=0.25)+
  geom_boxplot( aes(group=year), outlier.shape=NA, show.legend = FALSE)+ #plot boxplots without outliers since in jitter
  scale_color_manual(values = c("2013"="black" , "2014"="black", "2015"="#D55E00" , "2016"= "#D55E00" , "2017"="black", "2018"="black"))+
  geom_jitter(alpha=0.3, color="#999999" , width=0.15)+
  geom_text(data= summary_yrs, aes(x = factor(year), y = median_temp_175m, label = paste0("Median:", round(median_temp_175m, 2))), size = 2.5, vjust = -0.5)+ #label
  #geom_text(data= summary_yrs, aes(x =factor(year), y = median_temp_175m, label = paste0("n: ", n)), size = 2, vjust = 1.5, color="black")+ #label sample size 
  xlab("Year")+
  ylab("Temperature at 175 m [C]")+
  ggthemes::theme_few()+
  theme(legend.position = 'none')

ggsave(filename = "./plots/analysis 2/oceano/box_temp_meso.pdf", width=170, height= 100,units="mm", dpi=300)
```

# Temp at meso depths (175m) between years 
```{r}

ggplot(data=acoustics_ctd, aes(x=as.factor(year), y=temp_10m, group=year, color=as.factor(year)))+
  stat_boxplot(geom="errorbar", width=0.25)+
  geom_boxplot( aes(group=year), outlier.shape=NA, show.legend = FALSE)+ #plot boxplots without outliers since in jitter
  scale_color_manual(values = c("2013"="black" , "2014"="black", "2015"="#D55E00" , "2016"= "#D55E00" , "2017"="black", "2018"="black"))+
  geom_jitter(alpha=0.3, color="#999999" , width=0.15)+
  geom_text(data= summary_yrs, aes(x = factor(year), y = median_temp_10m, label = paste0("Median:", round(median_temp_10m, 2))), size = 2.5, vjust = -0.5)+ #label
  #geom_text(data= summary_yrs, aes(x =factor(year), y = median_temp_175m, label = paste0("n: ", n)), size = 2, vjust = 1.5, color="black")+ #label sample size 
  xlab("Year")+
  ylab("Temperature in upper 10 m [C]")+
  ggthemes::theme_few()+
  theme(legend.position = 'none')

ggsave(filename = "./plots/analysis 2/oceano/box_temp_surface.pdf", width=170, height= 100,units="mm", dpi=300)
```

# MVBS between years
```{r}

ggplot(data=acoustics_ctd, aes(x=as.factor(year), y=MVBS, group=year, color=as.factor(year)))+
  stat_boxplot(geom="errorbar", width=0.25)+
  geom_boxplot( aes(group=year), outlier.shape=NA, show.legend = FALSE)+ #plot boxplots without outliers since in jitter
  scale_color_manual(values = c("2013"="black" , "2014"="black", "2015"="#D55E00" , "2016"= "#D55E00" , "2017"="black", "2018"="black"))+
  geom_jitter(alpha=0.3, color="#999999" , width=0.15)+
  geom_text(data= summary_yrs, aes(x = factor(year), y = median_MVBS, label = paste0("Median:", round(median_MVBS, 2))), size = 2.5, vjust = -0.5)+ #label
  xlab("Year")+
  ylab("MVBS [dB re 1 m-1]")+
  ggthemes::theme_few()+
  theme(legend.position = 'none')

ggsave(filename = "./plots/analysis 2/oceano/box_mvbs.pdf", width=170, height= 100,units="mm", dpi=300)
```
# Chl-a
```{r}

ggplot(data=acoustics_ctd, aes(x=as.factor(year), y=chl_100m, group=year, color=as.factor(year)))+
  stat_boxplot(geom="errorbar", width=0.25)+
  geom_boxplot( aes(group=year), outlier.shape=NA, show.legend = FALSE)+ #plot boxplots without outliers since in jitter
  scale_color_manual(values = c("2013"="black" , "2014"="black", "2015"="#D55E00" , "2016"= "#D55E00" , "2017"="black", "2018"="black"))+
  geom_jitter(alpha=0.3, color="#999999" , width=0.15)+
  geom_text(data= summary_yrs, aes(x = factor(year), y = median_chl, label = paste0("Median:", round(median_chl, 2))), size = 2.5, vjust = -0.5)+ #label
  xlab("Year")+
  ylab("Chl in upper 100 m [ug/L]")+
  ggthemes::theme_few()+
  theme(legend.position = 'none')

ggsave(filename = "./plots/analysis 2/oceano/box_chl.pdf", width=170, height= 100,units="mm", dpi=300)
```
If i want to add values, need to add to summary_yrs (can do easily, but haven't)

# Oxygen
```{r}

ggplot(data=acoustics_ctd, aes(x=as.factor(year), y=o2_175m, group=year, color=as.factor(year)))+
  stat_boxplot(geom="errorbar", width=0.25)+
  geom_boxplot( aes(group=year), outlier.shape=NA, show.legend = FALSE)+ #plot boxplots without outliers since in jitter
  scale_color_manual(values = c("2013"="black" , "2014"="black", "2015"="#D55E00" , "2016"= "#D55E00" , "2017"="black", "2018"="black"))+
  geom_jitter(alpha=0.3, color="#999999" , width=0.15)+
  geom_text(data= summary_yrs, aes(x = factor(year), y = median_o2_175m, label = paste0("Median:", round(median_o2_175m, 2))), size = 2.5, vjust = 1.5)+ #label
  xlab("Year")+
  ylab("Oxygen at 175 m [ml/l]")+
  ggthemes::theme_few()+
  theme(legend.position = 'none')

ggsave(filename = "./plots/analysis 2/oceano/box_DO.pdf", width=170, height= 100,units="mm", dpi=300)
```


# end...



































